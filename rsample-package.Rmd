---
title: "rsample"
output: html_notebook
---


```{r setup}
options(max.print = 100, paged.print = FALSE)
```


```{r}
library(tidymodels)
```


## Overview

```{r}
library(rsample)
library(mlbench)
library(lobstr)
library(tidymodels)
```


```{r}
data("LetterRecognition")
obj_size(LetterRecognition)
```


```{r}
object.size(LetterRecognition)
```


```{r}
set.seed(35222)
boots <- bootstraps(LetterRecognition, times = 50)
obj_size(boots)
```


```{r}
object.size(boots)
```


```{r}
obj_size(boots)/nrow(boots)
```


```{r}
as.numeric(obj_size(boots)/obj_size(LetterRecognition))
```


```{r}
boots
```


```{r}
boots$splits[[1]]
```


```{r}
str(boots$splits[[1]])
```


```{r}
dim(analysis(boots$splits[[1]]))
```


```{r}
dim(assessment(boots$splits[[1]]))
```


```{r}
dim(assessment(boots$splits[[2]]))
```


## Basics

```{r}
set.seed(8584)
bt_resamples <- bootstraps(mtcars, times = 3)
bt_resamples
```


```{r}
class(bt_resamples)
```


```{r}
first_resample <- bt_resamples$splits[[1]]
first_resample
```


```{r}
as.data.frame(first_resample)
```


```{r}
as.data.frame(first_resample, data = "assessment")
```


```{r}
analysis(first_resample)
```


```{r}
assessment(first_resample)
```


## Working with rsets

### Intdocution

```{r}
data("attrition", package = "modeldata")
names(attrition)
table(attrition$Attrition)
```


```{r}
glm(Attrition ~ JobSatisfaction + Gender + MonthlyIncome, data = attrition, 
    family = binomial)
```


```{r}
mod_form <- as.formula(Attrition ~ JobSatisfaction + Gender + MonthlyIncome)
```


```{r}
set.seed(4622)
rs_obj <- vfold_cv(attrition, v = 10, repeats = 10)
rs_obj
```


```{r}
holdout_results <- function(splits, ...) {
  mod <- glm(..., data = analysis(splits), family = binomial)
  holdout <- assessment(splits)
  res <- broom::augment(mod, newdata = holdout)
  lvls <- levels(holdout$Attrition)
  predictions <- factor(ifelse(res$.fitted >0, lvls[2], lvls[1]), levels = lvls)
  res$correct <- predictions == holdout$Attrition
  res
}
```


```{r}
example <- holdout_results(rs_obj$splits[[1]], mod_form)
dim(example)
dim(assessment(rs_obj$splits[[1]]))
example[1:10, setdiff(names(example), names(attrition))]
```


```{r}
holdout_results <- function(splits, ...) {
  mod <- glm(..., data = analysis(splits), family = binomial)
  holdout <- assessment(splits)
  res <- broom::augment(mod, newdata = holdout)
  lvls <- levels(holdout$Attrition)
  predictions <- factor(ifelse(res$.fitted >0, lvls[2], lvls[1]), levels = lvls)
  res$correct <- predictions == holdout$Attrition
  res
}

example <- holdout_results(rs_obj$splits[[1]], mod_form)
dim(example)
dim(assessment(rs_obj$splits[[1]]))
example[1:10, setdiff(names(example), names(attrition))]
```


```{r, paged.print = TRUE}
splits <- rs_obj$splits[[1]]
mod <- glm(mod_form, data = analysis(splits), family = binomial)
holdout <- assessment(splits)
holdout
```


```{r, paged.print = TRUE}
res <- broom::augment(mod, newdata = holdout)
res
```


```{r}
lvls <- levels(holdout$Attrition)
predictions <- factor(ifelse(res$.fitted >0, lvls[2], lvls[1]), levels = lvls)
predictions
```


```{r}
res$correct <- predictions == holdout$Attrition
res[, setdiff(names(example), names(attrition))]
```


```{r}
library(purrr)
rs_obj$results <- map(rs_obj$splits, holdout_results, mod_form)
rs_obj
```


```{r}
rs_obj$accuracy <- map_dbl(rs_obj$results, function(x) mean(x$correct))
summary(rs_obj$accuracy)
```


```{r}
hist(rs_obj$accuracy)
```


### Using the bootstrap to make comparisons

```{r}

```


```{r}
ggplot(attrition, aes(Gender, MonthlyIncome)) +
  geom_boxplot() +
  scale_y_log10()
```


```{r}
median_diff <- function(splits) {
  x <- analysis(splits)
  median(x$MonthlyIncom[x$Gender == "Female"]) -
    median(x$MonthlyIncome[x$Gender == "Male"])
}
```


```{r}
set.seed(353)
bt_resamples <- bootstraps(attrition, times = 500)
```


```{r}
bt_resamples$wage_diff <- map_dbl(bt_resamples$splits, median_diff)
bt_resamples
```


```{r}
ggplot(bt_resamples, aes(wage_diff)) +
  geom_density(adjust = 1.25) +
  xlab("Difference in Median Montly Income (Female - Male)")
```


```{r}
glm_coefs <- function(splits, ...) {
  mod <- glm(..., data = analysis(splits), family = binomial)
  as.data.frame(t(coef(mod)))
}
bt_resamples$betas <- map(bt_resamples$splits, glm_coefs, mod_form)
bt_resamples
```


### Keeping tidy

```{r}
first_resample <- bt_resamples$splits[[1]]
class(first_resample)
```


```{r}
tidy(first_resample)
```


```{r}
class(bt_resamples)
```


```{r}
tidy(bt_resamples)
```


## Recipes with rsample

```{r}
library(AmesHousing)
ames <- make_ames()
ames
```


```{r}
theme_set(theme_bw())
ggplot(ames, aes(Lot_Area)) +
  geom_histogram(bindwidth = 5000, col = "red", fill = "red", alpha = .5)
```


```{r}
ggplot(ames, aes(Neighborhood)) + geom_bar() + coord_flip() + xlab("")
```


```{r}
library(recipes)
rec <- 
  recipe(Sale_Price ~ Neighborhood + House_Style + Year_Sold + Lot_Area,
         data = ames) %>% 
  step_log(Sale_Price, base = 10) %>% 
  step_other(Neighborhood, House_Style, threshold = 0.05) %>% 
  step_dummy(all_nominal()) %>% 
  step_BoxCox(Lot_Area) %>% 
  step_center(all_predictors()) %>% 
  step_scale(all_predictors())
rec
```


```{r}
rec_training_set <- prep(rec, training = ames)
rec_training_set
```


```{r}
bake(rec_training_set, new_data = head(ames))
```


```{r}
juice(rec_training_set) %>% head
```


```{r}
set.seed(7712)
bt_samples <- bootstraps(ames)
bt_samples
```


```{r}
bt_samples$splits[[1]]
```


```{r}
bt_samples$recipes <- map(bt_samples$splits, prepper, recipe = rec)
bt_samples
```


```{r}
fit_lm <- function(rec_obj, ...)
  lm(..., data = juice(rec_obj, everything()))

bt_samples$lm_mod <- 
  map(
    bt_samples$recipes,
    fit_lm,
    Sale_Price ~ .
  )
bt_samples
```


```{r}
pred_lm <- function(split_obj, rec_obj, model_obj, ...) {
  mod_data <- bake(
    rec_obj, 
    new_data = assessment(split_obj),
    all_predictors(),
    all_outcomes()
  ) 
  
  out <- mod_data %>% select(Sale_Price)
  out$predicted <- predict(model_obj, newdata = mod_data %>% select(-Sale_Price))
  out
}

bt_samples$pred <- 
  pmap(
    lst(
      split_obj = bt_samples$splits, 
      rec_obj = bt_samples$recipes, 
      model_obj = bt_samples$lm_mod
    ),
    pred_lm 
  )
bt_samples
```


```{r}
results <- map_dfr(bt_samples$pred, rmse, Sale_Price, predicted)
results
```


```{r}
mean(results$.estimate)
```

